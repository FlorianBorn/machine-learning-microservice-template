node {
    stage("checkout") {
        checkout(scm)
    }

    stage("get config variables") {
        config = readYaml(file: "jenkins/config.yaml")
    }
}

node("ansible") {
    
     checkout(scm)
    stage("setup microk8s") {
        dir("ansible") {
            sh "ansible-playbook main.yaml -i inventory -u ansible --extra-vars 'ansible_ssh_pass=0000'"
        }
    }
}

node("k8s") {

    stage("Deploy to k8s") {
        sh "jenkins/deploy/deployment.sh ${config.production_image_name} ${config.production_image_tag} ${config.repository} ${config.deployment_name}"
        
    }   

}
