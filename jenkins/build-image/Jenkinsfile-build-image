node {
    checkout(scm)
    config = readYaml(file: "jenkins/config.yaml")

    stage("Lint Webservice") {
        withDockerContainer(image: "${config.repository}/${config.runtime_image_name}:${config.runtime_tag}", args: "-u 0:0") {
            sh "pylint --exit-zero --extension-pkg-whitelist=pydantic main.py" // --exit-zero returns always 0
        }
    }

    stage("Lint Dockerfile") {
        dir("dockerfiles/production-image") {
            sh "docker run --rm -i hadolint/hadolint < Dockerfile"
        }
    }

    stage("Build Image") {       
        sh "echo Build Image"
        sh "jenkins/build-image/build.sh ${config.production_image_name} ${config.production_tag}"
    }    

    stage("Test Image") {
        sh "echo Build the Production Image!"
        withDockerContainer(image: "${config.repository}/${config.runtime_image_name}:${config.runtime_tag}", args: "-u 0:0") {
            sh "python3 jenkins/build-image/test.py ${config.production_image_name} ${config.production_image_tag}"
        }

    }
    // stage("Push Image") {
    //     steps {
    //         sh "echo Push Model!"
    //         dir("jenkins/build-image") {
    //             // ToDo
    //         }                
    //     }
    // }
}